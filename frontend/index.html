<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voice Calendar Assistant</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* =======================
       GLOBAL CSS
    ======================= */
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); min-height: 100vh; color: #333; }
    .container { max-width: 1200px; margin:0 auto; padding:20px; }
    .header { text-align:center; margin-bottom:30px; color:white; }
    .header h1 { font-size:2.8rem; margin-bottom:10px; display:flex; align-items:center; justify-content:center; gap:15px; }
    .subtitle { font-size:1.2rem; opacity:0.9; }
    .panel { background: rgba(255,255,255,0.95); border-radius:15px; padding:25px; margin-bottom:20px; box-shadow:0 10px 30px rgba(0,0,0,0.2); backdrop-filter: blur(10px); }
    .panel h2 { color:#2575fc; margin-bottom:20px; padding-bottom:10px; border-bottom:2px solid #f0f0f0; display:flex; align-items:center; gap:10px; }
    .status-container { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:15px; margin-bottom:20px; }
    .status-item { background:#f8f9fa; border-radius:10px; padding:15px; display:flex; align-items:center; gap:12px; border-left:4px solid #6a11cb; }
    .status-icon { font-size:1.2rem; width:30px; height:30px; display:flex; align-items:center; justify-content:center; border-radius:50%; }
    .status-text { font-weight:500; }
    .btn-container { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin:20px 0; }
    .btn { padding:14px 28px; border:none; border-radius:10px; font-size:1rem; font-weight:600; cursor:pointer; transition:all 0.3s ease; display:flex; align-items:center; justify-content:center; gap:10px; min-width:200px; }
    .btn:hover { transform: translateY(-3px); box-shadow:0 8px 15px rgba(0,0,0,0.2); }
    .btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; box-shadow:none; }
    .btn-primary { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color:white; }
    .btn-success { background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%); color:white; }
    .btn-danger { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); color:white; }
    .btn-warning { background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%); color:#333; }
    .voice-section { text-align:center; padding:30px; }
    .voice-circle { width:150px; height:150px; background:linear-gradient(135deg,#6a11cb 0%,#2575fc 100%); border-radius:50%; margin:0 auto 20px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.3s ease; position:relative; box-shadow:0 10px 25px rgba(106,17,203,0.3); }
    .voice-circle:hover { transform:scale(1.05); box-shadow:0 15px 35px rgba(106,17,203,0.4); }
    .voice-circle.recording { background:linear-gradient(135deg,#ff416c 0%,#ff4b2b 100%); animation:pulse 1.5s infinite; }
    @keyframes pulse { 0% { transform:scale(1); box-shadow:0 10px 25px rgba(255,65,108,0.3);} 50% { transform:scale(1.05); box-shadow:0 15px 35px rgba(255,65,108,0.5);} 100% { transform:scale(1); box-shadow:0 10px 25px rgba(255,65,108,0.3);} }
    .voice-icon { font-size:4rem; color:white; }
    .voice-instructions { color:#666; margin-top:15px; font-style:italic; }
    .response-box { background:#f8f9fa; border-radius:10px; padding:20px; margin-top:20px; min-height:100px; border-left:4px solid #2575fc; }
    .response-text { font-size:1.1rem; line-height:1.6; }
    .event-details { background:white; border-radius:8px; padding:15px; margin-top:15px; border:1px solid #e0e0e0; display:none; }
    .event-details h4 { color:#6a11cb; margin-bottom:10px; }
    .event-row { display:flex; gap:20px; margin-bottom:8px; }
    .event-label { font-weight:600; color:#555; min-width:100px; }
    .log-container { max-height:300px; overflow-y:auto; padding:15px; background:#f8f9fa; border-radius:8px; margin-top:15px; }
    .log-entry { padding:8px 12px; margin-bottom:8px; background:white; border-radius:6px; border-left:3px solid #6a11cb; font-family:'Courier New',monospace; font-size:0.9rem; }
    .log-time { color:#888; margin-right:10px; }
    .log-success { color:#00b09b; }
    .log-error { color:#ff416c; }
    .log-info { color:#2575fc; }
    .examples { background:#e3f2fd; border-radius:10px; padding:20px; margin-top:20px; }
    .examples h4 { color:#2575fc; margin-bottom:10px; }
    .examples ul { list-style:none; }
    .examples li { padding:8px 0; border-bottom:1px dashed #b3e0ff; }
    .examples li:last-child { border-bottom:none; }
    .footer { text-align:center; color:white; margin-top:40px; padding:20px; opacity:0.9; }
    .disclaimer { font-size:0.9rem; margin-top:10px; color: rgba(255,255,255,0.7); }
    @media (max-width:768px) {
        .container { padding:10px; }
        .header h1 { font-size:2rem; flex-direction:column; gap:10px; }
        .btn { min-width:100%; }
        .status-container { grid-template-columns:1fr; }
        .event-row { flex-direction:column; gap:5px; }
    }
    /* Status colors */
    .status-online { color:#00b09b; }
    .status-offline { color:#ff416c; }
    .status-warning { color:#f7971e; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(-10px);} to{opacity:1; transform:translateY(0);} }
    .fade-in { animation:fadeIn 0.5s ease; }
</style>
</head>
<body>
<div class="container">
    <!-- HEADER -->
    <header class="header">
        <h1><i class="fas fa-calendar-alt"></i> Voice Calendar Assistant</h1>
        <p class="subtitle">Add events to Google Calendar using your voice</p>
    </header>

    <!-- SYSTEM PANEL -->
    <div class="panel">
        <h2><i class="fas fa-cogs"></i> System Status</h2>
        <div class="status-container">
            <div class="status-item">
                <div class="status-icon status-online"><i class="fas fa-server"></i></div>
                <div><div class="status-text" id="server-status">Server: Connecting...</div></div>
            </div>
            <div class="status-item">
                <div class="status-icon status-offline"><i class="fas fa-calendar-check"></i></div>
                <div><div class="status-text" id="calendar-status">Calendar: Not Initialized</div></div>
            </div>
            <div class="status-item">
                <div class="status-icon status-warning"><i class="fas fa-microphone"></i></div>
                <div><div class="status-text" id="voice-status">Voice: Ready</div></div>
            </div>
            <div class="status-item">
                <div class="status-icon status-offline"><i class="fas fa-user"></i></div>
                <div><div class="status-text" id="auth-status">Authentication: Required</div></div>
            </div>
        </div>
        <div class="btn-container">
            <button id="init-btn" class="btn btn-primary" onclick="initializeAssistant()"><i class="fas fa-play"></i> Initialize Assistant</button>
            <button id="login-btn" class="btn btn-warning" onclick="manualLogin()" disabled><i class="fas fa-sign-in-alt"></i> Manual Login</button>
            <button id="save-auth-btn" class="btn btn-success" onclick="saveAuthState()" disabled><i class="fas fa-save"></i> Save Login State</button>
            <button id="test-btn" class="btn btn-primary" onclick="testVoiceCommand()"><i class="fas fa-vial"></i> Test Command</button>
        </div>
    </div>

    <!-- VOICE PANEL -->
    <div class="panel">
        <h2><i class="fas fa-microphone"></i> Voice Control</h2>
        <div class="voice-section">
            <div class="voice-circle" id="voice-circle" onclick="toggleVoiceRecording()">
                <i class="fas fa-microphone voice-icon" id="voice-icon"></i>
            </div>
            <div id="voice-instructions" class="voice-instructions">Click the microphone and speak your event command</div>
            <div id="voice-result" style="display:none;">
                <h3>You said:</h3>
                <p id="voice-text" style="font-style:italic; color:#666;"></p>
            </div>
        </div>
        <div class="response-box">
            <h3><i class="fas fa-comment-dots"></i> Assistant Response</h3>
            <div id="response-text" class="response-text">Hello! Click "Initialize Assistant" to get started, then click the microphone to speak.</div>
            <div id="event-details" class="event-details">
                <h4><i class="fas fa-info-circle"></i> Event Details</h4>
                <div class="event-row"><span class="event-label">Title:</span><span id="event-title">-</span></div>
                <div class="event-row"><span class="event-label">Date:</span><span id="event-date">-</span></div>
                <div class="event-row"><span class="event-label">Time:</span><span id="event-time">-</span></div>
            </div>
        </div>
    </div>

    <!-- ACTIVITY LOG -->
    <div class="panel">
        <h2><i class="fas fa-history"></i> Activity Log</h2>
        <div id="activity-log" class="log-container">
            <div class="log-entry"><span class="log-time">[System]</span><span class="log-info">Application started. Ready to initialize.</span></div>
        </div>
    </div>

    <!-- EXAMPLES -->
    <div class="panel">
        <div class="examples">
            <h4><i class="fas fa-lightbulb"></i> Try saying:</h4>
            <ul>
                <li>"Schedule a team meeting tomorrow at 2 PM for 1 hour"</li>
                <li>"Add doctor appointment on Friday at 10:30 AM"</li>
                <li>"Create a project review meeting next Monday at 3 PM"</li>
                <li>"Set up lunch with Sarah tomorrow at 12:30 PM"</li>
                <li>"Add conference call today at 4 PM for 45 minutes"</li>
            </ul>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="footer">
        <p>Voice Calendar Assistant &copy; 2024 | Using Playwright for browser automation</p>
        <p class="disclaimer">Note: First-time use requires manual Google login. Click "Manual Login" after initialization.</p>
    </footer>
</div>

<!-- =======================
     JAVASCRIPT
======================= -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    let socket=null,isRecording=false,recognition=null,isInitialized=false,isAuthenticated=false;

    function logActivity(message,type='info'){
        const logContainer=document.getElementById('activity-log');
        const time=new Date().toLocaleTimeString();
        const logEntry=document.createElement('div');
        logEntry.className='log-entry fade-in';
        let typeClass='log-info';
        if(type==='error') typeClass='log-error';
        if(type==='success') typeClass='log-success';
        logEntry.innerHTML=`<span class="log-time">[${time}]</span><span class="${typeClass}">${message}</span>`;
        logContainer.prepend(logEntry);
        const entries=logContainer.querySelectorAll('.log-entry');
        if(entries.length>50) entries[entries.length-1].remove();
    }

    function updateStatus(element,text,statusClass){
        try{
            const elementMap={
                'server':document.getElementById('server-status'),
                'calendar':document.getElementById('calendar-status'),
                'voice':document.getElementById('voice-status'),
                'auth':document.getElementById('auth-status')
            };
            const elementRef=elementMap[element];
            if(elementRef){
                elementRef.textContent=text;
                const statusItem=elementRef.closest('.status-item');
                const icon=statusItem.querySelector('.status-icon');
                icon.className='status-icon '+statusClass;
                statusItem.classList.add('fade-in');
                setTimeout(()=>statusItem.classList.remove('fade-in'),500);
            }
        }catch(e){console.error('updateStatus error:',e);}
    }

    function showResponse(text,type){
        const responseElement=document.getElementById('response-text');
        responseElement.textContent=text;
        responseElement.className='response-text fade-in';
        if(type==='error') responseElement.style.color='#ff416c';
        else if(type==='success') responseElement.style.color='#00b09b';
        else responseElement.style.color='#333';
    }

    function showEventDetails(eventData){
        try{
            document.getElementById('event-title').textContent=eventData.title;
            document.getElementById('event-date').textContent=eventData.date;
            document.getElementById('event-time').textContent=`${eventData.start_time} to ${eventData.end_time}`;
            document.getElementById('event-details').style.display='block';
        }catch(e){console.error('showEventDetails error:',e);}
    }

    function hideEventDetails(){document.getElementById('event-details').style.display='none';}

    function initializeWebSocket(){
        try{
            socket=io();
            socket.on('connect',()=>{
                updateStatus('server','Server: Connected','status-online');
                logActivity('Connected to server','success');
            });
            socket.on('disconnect',()=>{
                updateStatus('server','Server: Disconnected','status-offline');
                logActivity('Disconnected from server','error');
            });
            socket.on('voice_response',(data)=>handleVoiceResponse(data));
            socket.on('login_response',(data)=>{
                if(data.success){updateStatus('auth','Authentication: In Progress','status-warning'); logActivity(data.message,'info'); showResponse(data.message,'info');}
                else {logActivity(`Login error: ${data.message}`,'error'); showResponse(`Login failed: ${data.message}`,'error');}
            });
            socket.on('auth_response',(data)=>{
                if(data.success){updateStatus('auth','Authentication: Saved','status-online'); logActivity(data.message,'success'); showResponse(data.message,'success'); isAuthenticated=true; document.getElementById('save-auth-btn').disabled=true;}
                else{logActivity(`Auth save error: ${data.message}`,'error'); showResponse(`Failed to save auth: ${data.message}`,'error');}
            });
            socket.on('test_response',(data)=>logActivity(`Test parsed: ${JSON.stringify(data.parsed)}`,'info'));
            socket.on('error',(data)=>{logActivity(`Socket error: ${data.message}`,'error'); showResponse(`Error: ${data.message}`,'error');});
        }catch(e){console.error('WebSocket init failed:',e); logActivity(`WebSocket init error: ${e.message}`,'error');}
    }

    function initializeVoiceRecognition(){
        try{
            if(!('webkitSpeechRecognition' in window)&&!('SpeechRecognition' in window)){
                updateStatus('voice','Voice: Not Supported','status-offline');
                showResponse('Voice recognition not supported. Use Chrome/Edge.','error');
                return false;
            }
            const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
            recognition=new SpeechRecognition();
            recognition.continuous=false; recognition.interimResults=false; recognition.lang='en-US'; recognition.maxAlternatives=1;

            recognition.onstart=()=>{
                updateStatus('voice','Voice: Listening...','status-online');
                document.getElementById('voice-circle').classList.add('recording');
                document.getElementById('voice-icon').className='fas fa-stop voice-icon';
            };
            recognition.onend=()=>{
                isRecording=false;
                document.getElementById('voice-circle').classList.remove('recording');
                document.getElementById('voice-icon').className='fas fa-microphone voice-icon';
                updateStatus('voice','Voice: Ready','status-warning');
            };
            recognition.onresult=(event)=>{
                const transcript=event.results[0][0].transcript;
                logActivity(`Voice recognized: ${transcript}`,'info');
                document.getElementById('voice-text').textContent=transcript;
                document.getElementById('voice-result').style.display='block';
                if(socket) socket.emit('voice_command',{text:transcript});
            };
            return true;
        }catch(e){console.error('Voice init error:',e); logActivity(`Voice init error: ${e.message}`,'error'); return false;}
    }

    function toggleVoiceRecording(){
        if(!recognition){showResponse('Voice not initialized','error'); return;}
        if(isRecording){recognition.stop(); isRecording=false;}
        else{recognition.start(); isRecording=true;}
    }

    function initializeAssistant(){
        if(isInitialized){showResponse('Assistant already initialized','info'); return;}
        initializeWebSocket(); initializeVoiceRecognition();
        updateStatus('calendar','Calendar: Ready','status-online');
        document.getElementById('login-btn').disabled=false;
        document.getElementById('save-auth-btn').disabled=false;
        isInitialized=true;
        showResponse('Assistant initialized. You can now login or test commands.','success');
        logActivity('Assistant initialized','success');
    }

    function manualLogin(){if(socket) socket.emit('manual_login');}
        async function manualLogin() {
    if (!socket || !socket.connected) {
        showResponse('Not connected to server. Please try again.', 'error');
        return;
    }

    logActivity('Manual login requested...', 'info');
    showResponse('Opening Google login page...', 'info');

    // 发送事件给后端
    socket.emit('manual_login_request');
}
    function saveAuthState(){if(socket) socket.emit('save_auth');}
    function testVoiceCommand(){if(socket) socket.emit('test_command',{text:'Schedule a meeting tomorrow 10 AM'});}

    function handleVoiceResponse(data){
        if(data.success){
            showResponse(data.message,'success');
            if(data.event) showEventDetails(data.event);
        }else showResponse(data.message,'error');
    }
</script>
</body>
</html>
